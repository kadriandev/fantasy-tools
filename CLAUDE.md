# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Setup and Development
- `pnpm dev` - Start development server (loads secrets and runs SST dev)
- `pnpm serve` - Start Next.js development server with Turbopack
- `pnpm build` - Build the Next.js application
- `pnpm start` - Start production server
- `pnpm lint` - Run ESLint checks

### Database Operations
- `pnpm db` - Access Drizzle Kit CLI (use with SST shell)
- `pnpm db:generate` - Generate database migrations

### Deployment
- `pnpm sst:deploy` - Deploy to production stage

## Project Architecture

### Tech Stack
- **Framework**: Next.js 15 with App Router
- **Database**: PostgreSQL with Drizzle ORM
- **Auth**: OpenAuth with Yahoo OAuth provider
- **Infrastructure**: SST v3 (deployed on AWS)
- **Payments**: Stripe integration
- **Cache**: Redis for session storage
- **AI**: Anthropic Claude API integration
- **UI**: Radix UI components with Tailwind CSS

### Core Structure

#### Authentication Flow
- OAuth through Yahoo Fantasy Sports API using OpenAuth
- User authentication handled in `auth/index.ts` and `src/lib/auth/`
- Protected routes use layout-based authentication checks in `src/app/(authenticated)/layout.tsx`
- Access tokens stored in HTTP-only cookies

#### Database Schema
Three main entities:
- `users` - User profile information
- `leagues` - Fantasy league data from Yahoo
- `user_to_league` - Many-to-many relationship with team associations
- `stats` - Weekly fantasy stats storage

#### Yahoo Fantasy Integration
- Client wrapper in `src/lib/yahoo/index.ts` using `yahoo-fantasy` package
- Comprehensive TypeScript types in `src/lib/yahoo/schemas.ts` and `src/lib/yahoo/types.ts`
- Key functions:
  - `getUserLeaguesFromYahoo()` - Fetch user's active leagues
  - `getCurrentWeekStats()` - Get current week fantasy stats
  - `getLeagueStatsFromYahoo()` - Historical stats retrieval
  - `getStandings()` - League standings

#### Infrastructure (SST v3)
- Modular infrastructure in `infra/` directory
- Auto-deployment on master branch pushes to production
- Separate staging environments
- VPC setup for database and Redis
- Database migrations run automatically on deployment

#### Premium Features
- Stripe subscription tiers control feature access
- "Trends" functionality requires paid subscription
- Subscription status checked in layout for route access

### Key Directories

#### `/src/app/`
- `(authenticated)/` - Protected routes requiring Yahoo OAuth
- `(public)/` - Public landing page
- Route-based organization with page.tsx files

#### `/src/components/`
- Reusable UI components
- `ui/` - Base Radix UI components with Tailwind styling
- `app-sidebar.tsx` - Main navigation component

#### `/src/lib/`
- `data/` - Database query functions
- `yahoo/` - Yahoo Fantasy API integration
- `stripe/` - Payment processing
- `auth/` - Authentication utilities
- `ai/` - Claude AI integration

#### `/infra/`
- SST infrastructure definitions
- Separate files for different AWS resources

### Development Notes

#### Database Migrations
- Schema defined in `src/db/*.sql.ts` files
- Use Drizzle Kit for migration generation
- Migrations auto-run in production deployments

#### Environment Variables
- Managed through SST secrets
- Local development uses `.env` file loaded by SST

#### Error Handling
- Consistent error handling pattern using `catchError()` utility
- Yahoo API errors gracefully handled with fallbacks

#### TypeScript
- Strict typing throughout
- Yahoo API responses fully typed
- Database schema types generated by Drizzle